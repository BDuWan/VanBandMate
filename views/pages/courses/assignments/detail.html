<div class="breadcomb-area">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="breadcomb-list">
                    <div class="row">
                        <div class="col-lg-9 col-md-6 col-sm-6 col-xs-12">
                                <div class="breadcomb-ctn">
                                    <h2>{{.Assignment.Name}}</h2>
                                    <p>Due {{FormatTime .Assignment.EndTime}}</p>
                                    <p>{{.Assignment.Description}}</p>
                                    <br>
                                    <h5>Result</h5>
                                    <p>{{.Result}}</p>

                                    <br>
                                    <h5>My work</h5>
                                    <div class="data-table-list" style="padding:0;">
                                        <div class="table-responsive">
                                            <div class="dataTables_wrapper">
                                                <table id="table-documents" class="table table-striped dataTable c-f-dataTable">
                                                    <thead>
                                                    <tr>
                                                        <th class="t-id">STT</th>
                                                        <th>Name</th>
                                                        <th>Action</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="basic-tb-hd row">
                                        <div class="col-lg-4 col-sm-12">
                                            <button class="btn btn-green btn-reco-mg btn-button-mg waves-effect"  id="uploadFiles">
                                                <a class="btn-green"><span><i class="fas fa-plus"></i></span> Add Documents</a>
                                            </button>
                                        </div>
                                        <div class="col-lg-4 col-sm-12">
                                            <button class="btn btn-green btn-reco-mg btn-button-mg waves-effect"  id="btn-submit">
                                                <a class="btn-green">Submit</a>
                                            </button>
                                        </div>
                                    </div>

                                    <div style="display: none;">
                                        <form id="uploadForm" enctype="multipart/form-data">
                                            <input type="file" id="fileInput" multiple/>
                                        </form>
                                    </div>
                                </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-xs-3">
                            <div class="breadcomb-report">
                                <button class="btn btn-primary" id="rollback" >Rollback</button>
                                <span id="stt-assignment">{{StatusAssignment .Status}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    function lenString(text, length) {
        let count = text.length;
        let stringText = text;
        if (count > length) {
            stringText = "..." + text.substring(count - length + 4, count);
        }
        return stringText
    }



    $(document).ready(function() {
        var assignmentID = {{.Assignment.AssignmentID}};
        var status ={{.Status}};
        if(status === 1){
            $("#rollback").hide();
            $("#btn-submit").show();
            $("#uploadFiles").show();
        }else{
            $("#rollback").show();
            $("#btn-submit").hide();
            $("#uploadFiles").hide();
        }
        $.fn.dataTable.ext.errMode = 'none';
        var table_documents = $('#table-documents').DataTable({
            "processing": true,
            "serverSide": true,
            ajax: {
                url: '/courses/api/files/'+assignmentID+"/1",
                type: 'POST',
                "contentType": "application/json",
                "data": function (d) {
                    return JSON.stringify(d);
                }

            },
            columns: [
                {
                    "data": null,
                    "searchable": false,
                    "orderable": false,
                    "render": function (data, type, full, meta) {
                        return table_documents.rows().count() > 0 ?
                            meta.row + meta.settings._iDisplayStart + 1 : 0;
                    }
                },
                {
                    data: 'file',
                    render:function (data){
                        return lenString(data,150);
                    },
                    createdCell: function(td, cellData) {
                        td.title = cellData;

                    },
                },
                {
                    data: 'file_user_id',
                        render: function (data, type, full, row) {
                    if (type === 'display') {

                        return `<div class="row" style="margin:0;">
                                                  <div class="col-sm-6 t-center">
                                                    <a href="/courses/download/fileUser/${data}">
                                                      <i class="fas fa-file-download cl-ed" aria-hidden="true" title="Download"></i>
                                                    </a>
                                                  </div>
                                                  <div class="col-sm-6 t-center">
                                                    <a>
                                                      <i class="fas fa-trash cl-del item-delete" data-delete="${data}" aria-hidden="true" title="Delete"></i>
                                                    </a>
                                                  </div>
                                                </div>`;


                    }
                    return data;
                }
                }
            ],

        "drawCallback": function (settings) {
            var api = this.api();
            var startIndex = api.context[0]._iDisplayStart;
            api.column(0, {page: 'current'}).nodes().each(function (cell, i) {
                cell.innerHTML = startIndex + i + 1;
            });
        },
        "ordering": true,
            lengthMenu: [[5, 10], ['5', '10']],
    });

        $("#fileInput").on("change", function() {
            uploadFiles();
        });

        $("#uploadFiles").on("click", function() {
            $("#fileInput").click();
        });
        $("#btn-submit").on("click", function() {
            submit();
        });

        $("#rollback").on("click", function() {
            var formData = new FormData();
            formData.append("assignment_id",assignmentID);
            $.ajax({
                type: "PUT",
                url: "/courses/rollback/assignment/1",  // replace with your server-side upload endpoint
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if(response === "Success"){
                        $('#stt-assignment').text('Has not been submitted');
                        $("#rollback").hide();
                        $("#btn-submit").show();
                        $("#uploadFiles").show();
                    }else{
                        swal({
                            title: 'Error !',
                            text: response,
                            icon: 'warning',
                            button: {
                                text: "Close",
                                value: true,
                                visible: true,
                                className: "btn btn-danger"
                            }
                        })
                    }

                },
                error: function () {
                    console.log('Error occurred while retrieving options');
                }
            });
        });

        function uploadFiles() {
            var formData = new FormData();
            var files = $("#fileInput")[0].files;

            for (var i = 0; i < files.length; i++) {
                formData.append("files[]", files[i]);
            }

            formData.append("assignment_id",assignmentID);

            $.ajax({
                type: "POST",
                url: "/courses/fileUser/upload/assignment",  // replace with your server-side upload endpoint
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if(response === "Success"){
                        swal({
                            title: 'Successfully !',
                            text: 'Upload document successfully',
                            icon: 'success',
                            button: {
                                text: "Close",
                                value: true,
                                visible: true,
                                className: "btn btn-primary"
                            }
                        })
                        table_documents.ajax.reload();
                    }else{
                        swal({
                            title: 'Error !',
                            text: response,
                            icon: 'warning',
                            button: {
                                text: "Close",
                                value: true,
                                visible: true,
                                className: "btn btn-danger"
                            }
                        })
                    }

                },
                error: function () {
                    console.log('Error occurred while retrieving options');
                }
            });

        }

        function submit() {
            var formData = new FormData();
            formData.append("assignment_id",assignmentID);
            var endTime = {{.Assignment.EndTime}};
            formData.append("end_time",endTime);
            $.ajax({
                type: "POST",
                url: "/courses/submit/assignment",  // replace with your server-side upload endpoint
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if(response === 2){
                        swal({
                            title: 'Successfully !',
                            text: 'Submit assignment successfully',
                            icon: 'success',
                            button: {
                                text: "Close",
                                value: true,
                                visible: true,
                                className: "btn btn-primary"
                            }
                        })
                        $('#stt-assignment').text('Submitted');
                        $("#rollback").show();
                        $("#btn-submit").hide();
                        $("#uploadFiles").hide();
                    }else if(response === 3){
                        swal({
                            title: 'Successfully !',
                            text: 'Submit assignment successfully',
                            icon: 'success',
                            button: {
                                text: "Close",
                                value: true,
                                visible: true,
                                className: "btn btn-primary"
                            }
                        })
                        $('#stt-assignment').text('Late submission');
                        $("#rollback").show();
                        $("#btn-submit").hide();
                        $("#uploadFiles").hide();
                    }else{
                        swal({
                            title: 'Error !',
                            text: response,
                            icon: 'warning',
                            button: {
                                text: "Close",
                                value: true,
                                visible: true,
                                className: "btn btn-danger"
                            }
                        })
                    }

                },
                error: function () {
                    console.log('Error occurred while retrieving options');
                }
            });

        }

        $('#table-documents tbody').on('click', '.item-delete', function() {
            var FileID = $(this).data('delete');
            swal({
                title: 'Confirm Delete ?',
                icon: 'warning',
                buttons: {
                    cancel: {
                        text: "Cancel",
                        value: null,
                        visible: true,
                        className: "btn btn-danger",
                        closeModal: true,
                    },
                    confirm: {
                        text: "OK",
                        value: true,
                        visible: true,
                        className: "btn btn-primary",
                        closeModal: true
                    }
                }
            }).then((result=>{
                if(result){
                    $.ajax({
                        url: '/courses/fileUser/' + FileID,
                        type: 'DELETE',
                        success: function (response) {
                            if(response === "Success"){
                                swal({
                                    title: 'Successfully !',
                                    icon: 'success',
                                    button: {
                                        text: "Close",
                                        value: true,
                                        visible: true,
                                        className: "btn btn-primary"
                                    }
                                })
                                table_documents.ajax.reload();
                            }else {
                                swal({
                                    title: 'Error !',
                                    text: response,
                                    icon: 'warning',
                                    button: {
                                        text: "Close",
                                        value: true,
                                        visible: true,
                                        className: "btn btn-danger"
                                    }
                                })
                            }

                        },
                        error: function (xhr, status, error) {
                            console.error("Error deleting row:", status, error);
                        }
                    });
                }

            }))

        });

        $("#btn-result").on("click", function() {
            var formData = new FormData();
            var userID = {{.UserID}};
            formData.append("assignment_id",assignmentID);
            formData.append("user_id",userID);
            formData.append("result",$('result').val());
            $.ajax({
                type: "PUT",
                url: "/courses/result/assignment",  // replace with your server-side upload endpoint
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if(response === "Success"){
                        swal({
                            title: 'Successfully !',
                            text: 'Update result successfully',
                            icon: 'success',
                            button: {
                                text: "Close",
                                value: true,
                                visible: true,
                                className: "btn btn-primary"
                            }
                        })
                    }else{
                        swal({
                            title: 'Error !',
                            text: response,
                            icon: 'warning',
                            button: {
                                text: "Close",
                                value: true,
                                visible: true,
                                className: "btn btn-danger"
                            }
                        })
                    }

                },
                error: function () {
                    console.log('Error occurred while retrieving options');
                }
            });
        });

    });
</script>